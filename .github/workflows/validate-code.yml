name: 'validation (code)'

on:
  # pull_request:
  push:
    branches:
      - main
    paths-ignore:
      - '.dbt/**'
      - '.github/**'
      - 'docs/**'
      - 'README.md'
  workflow_dispatch:

# Global workflow-level variables
env:
  BUNDLE_DIR: bundles/sample_bundle
  DBT_PROJECT_NAME: sample_project
  DOCS_OUTPUT_DIR: build/docs

jobs:
  validate:
    runs-on: ubuntu-latest
    environment: tst

    steps:
      # Checkout repository source code
      - name: Checkout
        uses: actions/checkout@v4

      # Setup Python + uv dependency manager
      # (custom composite action maintained in this repo)
      - uses: ./.github/actions/uv-setup

      # Run pre-commit hooks against the entire repository
      # Ensures formatting, linting, and basic static validation
      - name: pre-commit
        run: uv run pre-commit run --all-files

      # Execute unit tests
      # Fails pipeline if any test fails
      - name: pytest
        run: uv run pytest

      # Validate Databricks Asset Bundle (no deployment)
      # Ensures bundle configuration is syntactically and structurally correct
      - name: bundle validate
        uses: ./.github/actions/dab-command-aws
        with:
          bundle_path: ${{ env.BUNDLE_DIR }}
          bundle_environment: tst
          bundle_command: validate

          databricks_client_id: ${{ secrets.DATABRICKS_CLIENT_ID }}
          databricks_client_secret: ${{ secrets.DATABRICKS_CLIENT_SECRET }}

      # Compile dbt project against Databricks
      # Validates model graph, refs, sources, and SQL syntax
      # Does NOT execute models (safe for CI validation)
      - name: dbt compile
        uses: ./.github/actions/dbt-command
        with:
          dbt_command: compile
          dbt_project_name: ${{ env.DBT_PROJECT_NAME }}

          client_id: ${{ secrets.DATABRICKS_CLIENT_ID }}
          client_secret: ${{ secrets.DATABRICKS_CLIENT_SECRET }}

          host: ${{ vars.DATABRICKS_HOST }}
          http_path: ${{ vars.DATABRICKS_HTTP_PATH }}
          catalog: ${{ vars.DBT_CATALOG }}
          schema: ${{ vars.DBT_SCHEMA }}

      # Build static documentation using MkDocs
      # Output goes to build/docs/
      - name: mkdocs build
        run: uv run mkdocs build
